<form class="" id="chat_form">

    <div id="chat_list" class="mb-3 border" style="min-height: 170px ; max-height: 210px; overflow:scroll ">

        <p class="text-sm-start">
            <span class="badge rounded-pill text-bg-light">è‡ªå·±ï¼š</span>
            å‘é€çš„ä¿¡æ¯
        </p>
        <p class="text-sm-start">
            <span class="badge rounded-pill text-bg-secondary   ">è‡ªå·±ï¼š</span>
            å‘é€çš„ä¿¡æ¯
        </p>

    </div>

    <div class="row">
        <div class="col-auto">
            <input type="text" class="form-control" id="input_message" aria-label="è¾“å…¥èŠå¤©å†…å®¹"/>
        </div>
        <div class="col">
            <button class="btn btn-primary mb-3" onclick="sendChatMessage();" type="button"> å‘é€</button>
        </div>
    </div>

</form>

<script id="tpl_snd_msg" type="text/html">
    <p class="text-sm-start">
        <span class="badge rounded-pill text-bg-secondary">è‡ªå·±ï¼š</span>
        <span class="my-msg">
                    {{msg}}
                    </span>
    </p>
</script>

<script id="tpl_rcv_msg" type="text/html">
    <p class="text-sm-end">
        <span class="badge rounded-pill text-bg-info">fromï¼š{from}</span>
        <span class="others-msg">
                    {{msg}}
                    </span>
    </p>
</script>
<script>

    var url = "ws://127.0.0.1:9502"

    var socket = new WebSocket(url);
    var chatList = new ChatList('#chat_list');

    socket.onopen = function () {
        chatList.appendRawMessage('<p>è¿æ¥æˆåŠŸ</p>');
    }

    socket.onmessage = function (msg) {
        // console.log(msg) ;
        // JSON.parse éœ€è¦å¤„ç†æ¿¹
        // chatList.appendMessage(msg.msg);
        var data = JSON.parse(msg.data);

        var userId = data['userId'];
        // console.log(data.msg);
        // alert("æœ‰æ¶ˆæ¯å•¦");
        // å•¥æƒ…å†µ è¿ç»­ä¸¤æ¬¡ è§£ç ï¼ï¼ï¼ğŸ‘
        var m = JSON.parse(data.msg);
        // chatList.appendRawMessage(m.msg);
        // console.log(typeof data.msg);

        chatList.appendOthersMessage(m.msg,userId);
    }

    socket.onclose = function () {
        // log1('æ–­å¼€è¿æ¥')
        chatList.appendRawMessage('æ–­å¼€é“¾æ¥å•¦ï¼ã€€');
    }

    function ChatList(selector) {
        this.element = $(selector);
    }

    ChatList.prototype.appendRawMessage = function (msg) {
        // var msgWrapper = $()
        // this.element.append($("p").addClass('text-sm-start').append(
        //    $('span').addClass('badge rounded-pill text-bg-info').html( msg)
        // ));
        // this.element.append('<p>'+msg+'</p>');
        this.element.append(msg);
        this.element.scrollTop(this.element[0].scrollHeight);
    }
    ChatList.prototype.appendOwnMessage = function (msg) {
        // TODO å¯ä»¥ææˆChatListç§æœ‰æˆå‘˜
        var $tpl_snd_msg = $('#tpl_snd_msg');
        // var $tpl = $tpl_snd_msg.clone(); // æ¨¡ç‰ˆå…‹éš†
        // var $msgContainer =   $tpl;
        var msgContainer = $tpl_snd_msg.clone();
        ;
        var $msgContainer = $(msgContainer.html());
        $msgContainer.find('.my-msg').text(msg);
        // var $msgSpan = $msgContainer.find('span') ;
        // alert($msgSpan.length);
        this.appendRawMessage($msgContainer);

    }
    ChatList.prototype.appendOthersMessage = function (msg, userId) {
        // TODO å¯ä»¥ææˆChatListç§æœ‰æˆå‘˜
        var $tpl_rcv_msg = $('#tpl_rcv_msg');

        var msgContainer = $tpl_rcv_msg.clone();
        // è¿™é‡Œå¥½å¥‡æ€ªå‘€ è¦å†åŒ…è£…ä¸€æ¬¡
        var $msgContainer = $(msgContainer.html());
        var $othersMsg = $msgContainer.find('.others-msg').text(msg);

        if (userId) {
            $othersMsg.prev().text("from: " + userId);
        }
        // var $msgSpan = $msgContainer.find('span') ;
        // alert($msgSpan.length);
        this.appendRawMessage($msgContainer);

    }

    function sendChatMessage() {
        var $input = $("#input_message");
        var msg = $input.val();

        // ä¹Ÿå¯ä»¥ç”¨jquery $.toJSON(str), $.evalJSON(str), phpç«¯ï¼š json_decode(), json_encode()
        // æ³¨æ„æ—§ç‰ˆæµè§ˆå™¨ å¯ä»¥è‡ªå·±å¼•å…¥ï¼šhttps://github.com/douglascrockford/JSON-js

        // åˆ°åº•å‘é€ä»€ä¹ˆæ•°æ®æ ¼å¼æ¯”è¾ƒè‡ªç”± ä½†æœ€å¥½é€‰æ‹©æ˜“äºç†è§£ ä¸”æ¯”è¾ƒæ–¹ä¾¿çš„ å¯ä»¥å‚è€ƒä¸‹çŸ¥åæ¡†æ¶éƒ½æ€ä¹ˆåšçš„
        // vue react ç­‰ æ ¼å¼{action:user_create , payload: {} }  æˆ–è€…å¦‚jsonrpc é£æ ¼ä¹Ÿæ¯”è¾ƒä¸é”™

        var json = JSON.stringify({
            "type": "php",
            "msg": msg
        });
        // console.log(json) ;
        socket.send(json);
        chatList.appendOwnMessage(msg);


        $input.val('');
        // $input.closest('form').preventDefault() ;
    }

    // var form = document.getElementsByTagName('form')[0] // æœ¬é¡µé¢æœ‰å¤šä¸ªformå“¦ æœ€å¥½ç”¨idè·å–å§ï¼
    var form = document.getElementById('chat_form');
    // console.log(form);
    // æˆ–è€…é€šè¿‡idä¹Ÿå¯ä»¥ ï¼› åœ¨è¡¨å•ä¸Šé€šè¿‡ onsubmit = "return false; " ä¼šé˜»æ­¢ç©ºæ ¼åè€…ä¼šè½¦æäº¤ï¼
    form.addEventListener('submit', function (e) {
        // alert('submit');
        e.preventDefault();

        sendChatMessage();
    })

</script>


